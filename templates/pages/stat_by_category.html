{% extends 'base.html' %}
{% load static %}

{% block title %}–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è–º–∏{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/stat_by_category.css' %}">
{% endblock %}

{% block content %}
<div class="container py-5">
    
    <div class="header-section">
        <div>
            <h1 class="page-title">–§—ñ–Ω–∞–Ω—Å–æ–≤–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h1>
            <p class="text-muted">–î–µ—Ç–∞–ª—å–Ω–∏–π –∞–Ω–∞–ª—ñ–∑ –¥–æ—Ö–æ–¥—ñ–≤ —Ç–∞ –≤–∏—Ç—Ä–∞—Ç</p>
        </div>
        <div class="total-badge">
            –ö–∞—Ç–µ–≥–æ—Ä—ñ–π: {{ data|length }}
        </div>
    </div>

    <form method="get" class="filter-card mb-5">
        <div class="row g-3 align-items-end">
            
            <div class="col-md-4">
                <label class="filter-label">–†–∞—Ö—É–Ω–∫–∏ (Assets)</label>
                <div class="dropdown">
                    <button class="btn form-control-custom d-flex justify-content-between align-items-center w-100" 
                            type="button" 
                            id="assetsDropdown" 
                            data-bs-toggle="dropdown" 
                            data-bs-auto-close="outside" 
                            aria-expanded="false">
                        <span id="selectedCount" class="text-truncate">
                            {% if selected_assets %}
                                –û–±—Ä–∞–Ω–æ: {{ selected_assets|length }}
                            {% else %}
                                –í—Å—ñ —Ä–∞—Ö—É–Ω–∫–∏
                            {% endif %}
                        </span>
                        <span class="small opacity-50">‚ñº</span>
                    </button>

                    <div class="dropdown-menu glass-dropdown-menu w-100 p-2" aria-labelledby="assetsDropdown">
                        <div class="assets-list-scroll">
                            {% for asset in user_assets %}
                            <div class="form-check custom-checkbox mb-2">
                                <input class="form-check-input asset-checkbox" 
                                       type="checkbox" 
                                       name="assets" 
                                       value="{{ asset.id }}" 
                                       id="asset_{{ asset.id }}"
                                       {% if asset.id in selected_assets %}checked{% endif %}>
                                <label class="form-check-label text-white small w-100" for="asset_{{ asset.id }}">
                                    <span style="opacity: 0.6;">{{ asset.portfolio.name }}</span> ‚Äî {{ asset.get_type_display }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <label class="filter-label">–ó –¥–∞—Ç–∏</label>
                <input type="date" name="start_date" class="form-control-custom" value="{{ start_date|default:'' }}">
            </div>

            <div class="col-md-3">
                <label class="filter-label">–ü–æ –¥–∞—Ç—É</label>
                <input type="date" name="end_date" class="form-control-custom" value="{{ end_date|default:'' }}">
            </div>

            <div class="col-md-2 d-flex gap-2">
                <button type="submit" class="btn btn-primary w-100">–§—ñ–ª—å—Ç—Ä</button>
                <a href="{% url 'stat_by_category' %}" class="btn btn-dashed" title="–°–∫–∏–Ω—É—Ç–∏">‚úï</a>
            </div>
        </div>
    </form>

    <div class="stats-grid">
        {% for item in data %}
        <div class="stat-card">
            <div class="card-header">
                <div class="icon-circle bg-{{ item.color|default:'primary' }}-subtle text-{{ item.color|default:'primary' }}">
                    {{ item.icon|default:'üìä' }}
                </div>
                <h3 class="category-title">{{ item.name }}</h3>
            </div>

            <div class="card-body">
                <div class="stat-row">
                    <span class="label">–î–æ—Ö—ñ–¥</span>
                    <span class="value text-success">
                        +{{ item.income|floatformat:2 }} ‚Ç¥
                    </span>
                </div>
                <div class="stat-row">
                    <span class="label">–í–∏—Ç—Ä–∞—Ç–∏</span>
                    <span class="value text-danger">
                        -{{ item.expense|floatformat:2 }} ‚Ç¥
                    </span>
                </div>
                
                <div class="divider"></div>

                <div class="stat-row total">
                    <span class="label">–†—ñ–∑–Ω–∏—Ü—è</span>
                    <span class="value {% if item.difference >= 0 %}text-success{% else %}text-danger{% endif %}">
                        {{ item.difference|floatformat:2 }} ‚Ç¥
                    </span>
                </div>
            </div>

            <div class="card-footer">
                {% if item.income > 0 or item.expense > 0 %}
                    <div class="progress-container">
                        <div class="bar income" style="flex: {{ item.income }};" title="–î–æ—Ö—ñ–¥: {{ item.income|floatformat:0 }}"></div>
                        <div class="bar expense" style="flex: {{ item.expense }};" title="–í–∏—Ç—Ä–∞—Ç–∏: {{ item.expense|floatformat:0 }}"></div>
                    </div>
                {% endif %}
            </div>
        </div>
        {% empty %}
        <div class="empty-state">
            <div class="empty-icon">üìÇ</div>
            <p>–ó–∞ –æ–±—Ä–∞–Ω–∏–π –ø–µ—Ä—ñ–æ–¥ —Ä—É—Ö—É –∫–æ—à—Ç—ñ–≤ –Ω–µ –±—É–ª–æ</p>
        </div>
        {% endfor %}
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const checkboxes = document.querySelectorAll('.asset-checkbox');
        const countLabel = document.getElementById('selectedCount');

        function updateCount() {
            const checkedCount = document.querySelectorAll('.asset-checkbox:checked').length;
            if (checkedCount === 0) {
                countLabel.textContent = '–í—Å—ñ —Ä–∞—Ö—É–Ω–∫–∏';
            } else {
                countLabel.textContent = `–û–±—Ä–∞–Ω–æ: ${checkedCount}`;
            }
        }

        checkboxes.forEach(cb => {
            cb.addEventListener('change', updateCount);
        });
    });
</script>
{% endblock %}