{% extends 'base.html' %}
{% load static %}

{% block title %}Обробка платежів{% endblock %}

{% block extra_css %}
<style>
    /* Стилі терміналу */
    .terminal-window {
        background-color: #0f172a; /* Дуже темний фон */
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 20px;
        font-family: 'Courier New', Courier, monospace;
        color: #f8fafc;
        min-height: 300px;
        max-height: 500px;
        overflow-y: auto;
        box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.5);
        margin-top: 20px;
    }

    .log-line {
        margin-bottom: 5px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.03);
        padding-bottom: 2px;
        display: block;
    }

    /* Проста емуляція кольорів логів */
    .log-line:contains("ВІДХИЛЕНО"), .log-line:contains("Помилка") {
        color: #f87171; /* Червоний */
    }
    .log-line:contains("Оплачено"), .log-line:contains("SUCCESS") {
        color: #4ade80; /* Зелений */
    }
    .log-line:contains("WARNING"), .log-line:contains("Пропущено") {
        color: #fbbf24; /* Жовтий */
    }

    .status-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 10px;
    }
    .status-idle { background-color: #94a3b8; box-shadow: 0 0 10px #94a3b8; }
    .status-active { background-color: #4ade80; box-shadow: 0 0 10px #4ade80; }
</style>
<script>
    // JS хак, щоб підсвітити рядки, бо CSS :contains не існує в стандарті
    document.addEventListener("DOMContentLoaded", function() {
        const lines = document.querySelectorAll('.log-line');
        lines.forEach(line => {
            const text = line.textContent;
            if (text.includes('❌') || text.includes('ВІДХИЛЕНО') || text.includes('ERROR')) {
                line.style.color = '#f87171';
            } else if (text.includes('✅') || text.includes('Оплачено') || text.includes('SUCCESS')) {
                line.style.color = '#4ade80';
            } else if (text.includes('Пропущено') || text.includes('WARNING')) {
                line.style.color = '#fbbf24';
            }
        });
    });
</script>
{% endblock %}

{% block content %}
<div class="container mt-5" style="max-width: 800px;">
    
    <div class="glass-card p-4 text-center mb-4">
        <h2 class="mb-3">⚙️ Системна обробка</h2>
        <p class="text-secondary mb-4">
            Запуск цього процесу перевірить усі активні підписки та кредити. 
            Якщо сьогодні дата оплати, система автоматично створить транзакції та оновить баланси.
        </p>

        <form method="post">
            {% csrf_token %}
            <button type="submit" class="btn btn-primary btn-lg shadow-lg px-5">
                <i class="bi bi-play-circle-fill me-2"></i> Запустити обробку платежів
            </button>
        </form>
    </div>

    <div class="d-flex align-items-center mb-2">
        <span class="status-indicator {% if logs %}status-active{% else %}status-idle{% endif %}"></span>
        <span class="text-secondary small text-uppercase fw-bold">Лог виконання</span>
    </div>

    <div class="terminal-window">
        {% if logs %}
            {% for line in logs %}
                {% if line %}
                    <span class="log-line">{{ line }}</span>
                {% endif %}
            {% endfor %}
        {% else %}
            <span class="text-muted">> Очікування команди... Натисніть кнопку вище, щоб розпочати.</span>
        {% endif %}
    </div>

</div>
{% endblock %}